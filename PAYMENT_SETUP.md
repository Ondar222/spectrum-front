# Настройка платежной системы Альфа-Банк

## Обзор

Система оплаты сертификатов интегрирована с Альфа-Банком и поддерживает как тестовую, так и продакшн среду.

## Конфигурация

### Тестовая среда

- **URL**: https://alfa.rbsuat.com/payment/rest
- **Логин**: clinicaldan-operator
- **Пароль**: KACr2LiW3R?
- **Токен**: pfcr5js74l5jnsqcsrms960nok

### Продакшн среда

- **URL**: https://pay.alfabank.ru/payment/rest
- **Логин**: clinicaldan-operator
- **Пароль**: vy\_$2BTVD\*KVD#u/
- **Токен**: pfcr5js74l5jnsqcsrms960nok

## Запуск

### Разработка (тестовая среда)

```bash
npm run dev
```

### Продакшн

```bash
npm run build
npm start
```

## Тестирование

### 1. Тестовая страница

Перейдите на `/payment-test` для создания тестовых платежей.

### 2. Тестовые карты

#### Успешная оплата:

- **Номер**: 4111 1111 1111 1111
- **Срок**: 12/25
- **CVV**: 123

#### Отклоненная оплата:

- **Номер**: 4444 4444 4444 4444
- **Срок**: 12/25
- **CVV**: 123

### 3. Поток оплаты сертификатов

1. Пользователь переходит на `/certificates`
2. Заполняет форму с данными получателя и отправителя
3. Выбирает сумму сертификата
4. Нажимает "Оплатить"
5. Перенаправляется на страницу Альфа-Банка
6. Вводит данные карты и подтверждает оплату
7. Получает результат (успех/неудача)
8. Перенаправляется обратно на сайт

## API Endpoints

### Создание платежа

```
POST /api/payment/register
```

**Параметры:**

- `amount` - сумма в рублях
- `returnUrl` - URL для успешной оплаты
- `failUrl` - URL для неуспешной оплаты
- `description` - описание платежа

### Проверка статуса

```
POST /api/payment/status
```

**Параметры:**

- `orderId` - ID заказа

## Статусы платежей

- `0` - заказ зарегистрирован, но не оплачен
- `1` - предавторизованная сумма захолдирована
- `2` - проведена полная авторизация суммы заказа ✅
- `3` - авторизация отменена
- `4` - по транзакции была проведена операция возврата
- `5` - инициирована авторизация через ACS банка-эмитента
- `6` - авторизация отклонена

## Безопасность

- Все платежные данные передаются через HTTPS
- Токены и пароли не передаются на клиент
- Валидация всех входных данных
- Логирование всех операций

## Мониторинг

### Логи сервера

Все платежные операции логируются с уникальными ID для отслеживания.

### Страница мониторинга

Перейдите на `/payment-monitor` для просмотра статистики платежей.

## Устранение неполадок

### Ошибка "MISSING_PARAMETERS"

Проверьте, что все обязательные параметры переданы.

### Ошибка "INVALID_AMOUNT"

Сумма должна быть от 100 до 100 000 рублей.

### Ошибка Альфа-Банка

Проверьте:

1. Правильность токена
2. Доступность API Альфа-Банка
3. Корректность данных заказа

## Контакты

При возникновении проблем с платежной системой обращайтесь к технической поддержке.
