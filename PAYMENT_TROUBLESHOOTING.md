# Устранение проблем с платежной системой

## ✅ РЕШЕННАЯ ПРОБЛЕМА

**Проблема:** Платежи отклонялись с ошибкой "При передаче api токена, username и password должны отсутствовать"

**Решение:** Убрать параметры `userName` и `password` из запросов к API Альфа-Банка, оставить только `token`.

**Исправление в коде:**

```javascript
// НЕПРАВИЛЬНО (вызывало ошибку):
const requestData = {
  userName: ALFA_BANK_CONFIG.login,
  password: ALFA_BANK_CONFIG.password,
  orderNumber: orderNumber,
  amount: amount,
  token: ALFA_BANK_CONFIG.token,
};

// ПРАВИЛЬНО (работает):
const requestData = {
  orderNumber: orderNumber,
  amount: amount,
  token: ALFA_BANK_CONFIG.token,
};
```

## Диагностика проблем

### 1. Запуск диагностической страницы

Откройте страницу `/payment-diagnostic` для подробной диагностики платежной системы. Эта страница покажет:

- Логи всех запросов к API
- Ответы от сервера
- Ошибки Альфа-Банка
- Статусы платежей

### 2. Проверка логов сервера

Сервер теперь выводит подробные логи. Проверьте консоль сервера для диагностики:

```bash
# Запуск сервера с выводом логов
node server.js
```

## Основные причины отклонения платежей

### 1. ❌ Проблемы с конфигурацией Альфа-Банка (РЕШЕНО)

**Симптомы:**

- Ошибка "При передаче api токена, username и password должны отсутствовать"
- Ошибка "Invalid credentials"
- Ошибка "Access denied"

**Решение:**

- ✅ Убрать `userName` и `password` из запросов
- ✅ Использовать только `token` для аутентификации
- ✅ Проверьте правильность токена в `server.js`

### 2. Неправильный формат данных

**Симптомы:**

- Ошибка "Invalid amount"
- Ошибка "Invalid order number"

**Решение:**

- Сумма должна быть в копейках (умножена на 100)
- Номер заказа должен быть уникальным
- Все обязательные поля должны быть заполнены

### 3. Проблемы с URL возврата

**Симптомы:**

- Ошибка "Invalid return URL"
- Платеж создается, но не возвращается на сайт

**Решение:**

- URL должны быть доступны из интернета
- Проверьте правильность домена
- Убедитесь, что HTTPS настроен правильно

### 4. Проблемы с CORS

**Симптомы:**

- Ошибка "CORS policy"
- Запросы блокируются браузером

**Решение:**

- Сервер настроен для обхода CORS
- Проверьте настройки CORS в `server.js`

## Пошаговая диагностика

### Шаг 1: Проверка конфигурации

1. Откройте `/payment-diagnostic`
2. Введите сумму 1000 рублей
3. Нажмите "Создать тестовый платеж"
4. Проверьте логи на наличие ошибок

### Шаг 2: Проверка ответа Альфа-Банка

В логах ищите:

```
Ответ от Альфа-Банка: { ... }
```

Если есть `errorCode`, это указывает на проблему с Альфа-Банком.

### Шаг 3: Проверка статуса платежа

1. После создания платежа нажмите "Проверить статус"
2. Проверьте значение `orderStatus`:
   - `0` - заказ зарегистрирован, но не оплачен
   - `2` - проведена полная авторизация (ОПЛАЧЕНО)
   - `6` - авторизация отклонена

## Частые ошибки и решения

### ✅ Ошибка "При передаче api токена, username и password должны отсутствовать" (РЕШЕНО)

**Причина:** Неправильное использование API Альфа-Банка

**Решение:**

```javascript
// В server.js используйте только token:
const requestData = {
  orderNumber: orderNumber,
  amount: (amount * 100).toString(),
  returnUrl: returnUrl,
  failUrl: failUrl,
  description: description,
  token: ALFA_BANK_CONFIG.token, // Только токен!
};
```

### Ошибка "Invalid amount"

**Причина:** Неправильный формат суммы

**Решение:**

```javascript
// Сумма должна быть в копейках
amount: (amount * 100).toString();
```

### Ошибка "Order already exists"

**Причина:** Дублирование номера заказа

**Решение:**

```javascript
// Генерация уникального номера
const orderNumber = `cert_${Date.now()}_${Math.random().toString(36).substring(2, 15)}`;
```

### Ошибка "Network error"

**Причина:** Проблемы с подключением к Альфа-Банку

**Решение:**

1. Проверьте интернет-соединение
2. Проверьте доступность `https://alfa.rbsuat.com`
3. Проверьте настройки прокси

## Тестирование в продакшене

### 1. Переключение на продакшн API

Замените URL в `server.js`:

```javascript
// Тестовая среда
url: "https://alfa.rbsuat.com/payment/rest";

// Продакшн среда
url: "https://pay.alfabank.ru/payment/rest";
```

### 2. Обновление учетных данных

Получите новые учетные данные для продакшена от Альфа-Банка.

### 3. Настройка SSL

Убедитесь, что сайт работает по HTTPS.

## Мониторинг платежей

### 1. Логирование

Все платежи логируются в консоль сервера. Для продакшена рекомендуется:

- Настроить ротацию логов
- Отправлять критические ошибки в систему мониторинга
- Сохранять логи в базу данных

### 2. Уведомления

Настройте уведомления о:

- Неудачных платежах
- Отклоненных платежах
- Технических ошибках

### 3. Метрики

Отслеживайте:

- Количество успешных/неудачных платежей
- Время обработки платежей
- Популярные суммы платежей

## Контакты для поддержки

При возникновении проблем:

1. Проверьте диагностическую страницу `/payment-diagnostic`
2. Изучите логи сервера
3. Обратитесь в техподдержку Альфа-Банка
4. Проверьте документацию API Альфа-Банка

## Полезные ссылки

- [API Альфа-Банка](https://pay.alfabank.ru/ecom/instructions/)
- [Тестовая среда](https://alfa.rbsuat.com/)
- [Документация по интеграции](https://pay.alfabank.ru/ecom/instructions/)

## Статус системы

✅ **Платежная система работает корректно**

- Создание платежей: ✅
- Проверка статуса: ✅
- Обработка ошибок: ✅
- Логирование: ✅
