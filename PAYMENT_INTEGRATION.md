# Интеграция с платежной системой Альфа-Банка

## Обзор

Данная интеграция реализует платежную систему для подарочных сертификатов через API Альфа-Банка.

## Технические детали

### Конфигурация

- **URL API**: `https://alfa.rbsuat.com/payment/rest`
- **Токен**: `pfcr5js74l5jnsqcsrms960nok`
- **Логин**: `clinicaldan-operator`
- **Пароль**: `KACr2LiW3R?`

### Основные методы API

#### 1. Создание платежа (`register.do`)

**Endpoint**: `POST https://alfa.rbsuat.com/payment/rest/register.do`

**Параметры**:

- `userName` - логин
- `password` - пароль
- `orderNumber` - номер заказа (генерируется автоматически)
- `amount` - сумма в копейках
- `returnUrl` - URL для возврата после успешной оплаты
- `failUrl` - URL для возврата при отмене
- `description` - описание платежа
- `token` - токен доступа

**Ответ**:

```json
{
  "formUrl": "https://alfa.rbsuat.com/payment/rest/paymentorder.do?token=...",
  "orderId": "123456789"
}
```

#### 2. Проверка статуса заказа (`getOrderStatus.do`)

**Endpoint**: `POST https://alfa.rbsuat.com/payment/rest/getOrderStatus.do`

**Параметры**:

- `userName` - логин
- `password` - пароль
- `orderId` - ID заказа
- `token` - токен доступа

**Ответ**:

```json
{
  "orderStatus": 2,
  "orderNumber": "cert_1234567890_abc123",
  "amount": 100000,
  "currency": 810,
  "approvalCode": "123456"
}
```

### Статусы заказа

- `0` - заказ зарегистрирован, но не оплачен
- `1` - предавторизованная сумма захолдирована
- `2` - проведена полная авторизация суммы заказа (ОПЛАЧЕНО)
- `3` - авторизация отменена
- `4` - по транзакции была проведена операция возврата
- `5` - инициирована авторизация через ACS банка-эмитента
- `6` - авторизация отклонена

## Архитектура приложения

### Компоненты

#### 1. PaymentService (`src/services/payment.ts`)

Основной сервис для работы с платежами:

- `createAlfaBankPayment()` - создание платежа через прокси-сервер
- `checkAlfaBankOrderStatus()` - проверка статуса заказа через прокси-сервер
- `createCertificatePayment()` - создание платежа для сертификата
- `checkPaymentStatus()` - проверка статуса платежа
- `generateOrderNumber()` - генерация номера заказа

#### 2. Express.js Прокси-сервер (`server.js`)

Сервер для обхода CORS и проксирования запросов к Альфа-Банку:

- `/api/payment/register` - создание платежа
- `/api/payment/status` - проверка статуса заказа
- Статическая раздача файлов для продакшена

#### 3. GiftCertificatesPage (`src/components/GiftCertificatesPage.tsx`)

Страница оформления подарочных сертификатов:

- Форма для ввода данных получателя и отправителя
- Выбор суммы сертификата
- Создание платежа и редирект на страницу оплаты

#### 4. PaymentSuccessPage (`src/components/PaymentSuccessPage.tsx`)

Страница успешной оплаты:

- Проверка статуса платежа при загрузке
- Отображение результата оплаты
- Навигация к другим страницам

#### 5. PaymentCancelPage (`src/components/PaymentCancelPage.tsx`)

Страница отмены платежа:

- Информация об отмене
- Возможность повторить платеж

#### 6. PaymentTestPage (`src/components/PaymentTestPage.tsx`)

Тестовая страница для проверки интеграции:

- Создание тестовых платежей
- Проверка статуса заказов
- Отладка API

### Маршруты

- `/certificates` - страница подарочных сертификатов
- `/certificates/success` - страница успешной оплаты
- `/certificates/cancel` - страница отмены платежа
- `/payment-test` - тестовая страница

## Процесс оплаты

### 1. Создание платежа

1. Пользователь заполняет форму на странице `/certificates`
2. При нажатии "Оплатить" вызывается `createCertificatePayment()`
3. Генерируется `orderNumber` и `orderId`
4. Отправляется запрос к `register.do` с параметрами платежа
5. Получается `formUrl` от Альфа-Банка
6. Пользователь перенаправляется на страницу оплаты

### 2. Проверка статуса

1. После оплаты пользователь возвращается на `returnUrl`
2. Страница `PaymentSuccessPage` автоматически проверяет статус
3. Вызывается `checkPaymentStatus()` → `getOrderStatus.do`
4. Отображается результат в зависимости от статуса

### 3. Обработка ошибок

- При ошибках API отображается соответствующее сообщение
- При отмене платежа пользователь попадает на страницу отмены
- Все ошибки логируются в консоль

## Запуск приложения

### Разработка

1. Запустите прокси-сервер: `npm run server`
2. В другом терминале запустите фронтенд: `npm run dev`
3. Откройте http://localhost:5174

### Продакшен

1. Соберите проект: `npm run build`
2. Запустите сервер: `npm run server`
3. Откройте http://localhost:3001

## Тестирование

### Тестовая страница

Перейдите на `/payment-test` для тестирования:

1. Введите сумму платежа
2. Нажмите "Создать тестовый платеж"
3. Проверьте ответ API
4. Используйте "Проверить статус" для проверки статуса

### Тестовые данные

- Сумма: любая от 100 рублей
- Email: test@example.com
- Имя: Тестовый пользователь

## Безопасность

### Рекомендации

1. В продакшене используйте HTTPS
2. Храните токены в переменных окружения
3. Валидируйте все входящие данные
4. Логируйте все платежные операции
5. Реализуйте webhook для уведомлений о статусе

### Переменные окружения

```env
VITE_PAYMENT_API_URL=https://your-api.com
VITE_PAYMENT_API_KEY=your-api-key
```

## Поддержка

При возникновении проблем:

1. Проверьте консоль браузера на наличие ошибок
2. Убедитесь в корректности токена и учетных данных
3. Проверьте доступность API Альфа-Банка
4. Используйте тестовую страницу для отладки
