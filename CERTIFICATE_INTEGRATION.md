# Интеграция системы сертификатов с бекендом

## Обзор

Данная интеграция связывает фронтенд приложения с бекенд API для создания и управления подарочными сертификатами.

## Изменения в архитектуре

### 1. Новый сервис сертификатов

Создан файл `src/services/certificates.ts` который заменяет прямую работу с Альфа-Банком на использование собственного API.

**Основные методы:**
- `createCertificate()` - создание сертификата и получение ссылки на оплату
- `checkPaymentStatus()` - проверка статуса платежа
- `parseFullName()` - разделение полного имени на имя и фамилию
- `validateEmail()` - валидация email адреса
- `formatAmount()` - форматирование суммы

### 2. Обновленная страница оформления сертификатов

Файл `src/components/GiftCertificatesPage.tsx` обновлен для:

**Интеграция с API:**
- Использование нового API `/certificate/create`
- Автоматическое определение типа сертификата (подарочный/для себя)
- Правильная структура данных согласно DTO

**Улучшенная валидация:**
- Проверка наличия имени и фамилии (минимум 2 слова)
- Визуальная индикация ошибок валидации
- Подсказки в полях ввода

**Логика определения типа сертификата:**
- Если данные отправителя и получателя совпадают → сертификат для себя
- Если данные разные → подарочный сертификат

### 3. Обновленная страница успешной оплаты

Файл `src/components/PaymentSuccessPage.tsx` обновлен для использования нового API проверки статуса платежа через `/certificate/check-payment/:orderNumber`.

## Структура данных API

### Запрос создания сертификата

```typescript
interface CreateCertificateRequest {
  amount: number;
  customer: Customer;      // Получатель
  sponsor?: Customer;      // Отправитель (если подарочный)
  greetingText?: string;
}

interface Customer {
  firstName: string;
  lastName: string;
  email: string;
  phone?: string;
}
```

### Ответ создания сертификата

```typescript
interface CreateCertificateResponse {
  message: string;         // "Сертификат создан, ожидается оплата"
  code: string;           // "0000033"
  paymentUrl: string;     // Ссылка на оплату
  orderId: string;        // ID заказа
}
```

## Конфигурация

### Переменные окружения

Убедитесь, что в `.env` файле установлена переменная:

```env
VITE_API_URL=http://localhost:3001
```

Для продакшна замените на актуальный URL бекенда.

## Логика работы

### 1. Создание сертификата

1. Пользователь заполняет форму на странице `/certificates`
2. Фронтенд валидирует данные (имя+фамилия, email)
3. Определяется тип сертификата (подарочный/для себя)
4. Отправляется POST запрос на `/certificate/create`
5. Получается ссылка на оплату и происходит редирект

### 2. Проверка статуса оплаты

1. После оплаты пользователь попадает на `/certificates/success?orderId=...`
2. Фронтенд отправляет POST запрос на `/certificate/check-payment/:orderNumber`
3. Показывается статус на основе `orderStatus` из ответа:
   - `2` = оплачено успешно
   - `0` = ожидает оплаты
   - `3,6` = отклонено
   - другие = в обработке

## Валидация

### Клиентская валидация

- **Имена**: обязательно имя И фамилия (минимум 2 слова)
- **Email**: стандартная проверка формата
- **Сумма**: выбор из предопределенных значений

### Серверная валидация

Валидация происходит на бекенде согласно `CreateCertificateDto`:
- `@IsNumber()` для суммы
- `@IsEmail()` для email адресов
- `@IsString()` для имен
- `@ValidateNested()` для вложенных объектов

## Совместимость

Интеграция полностью заменяет прямую работу с Альфа-Банком на фронтенде. Вся логика оплаты теперь инкапсулирована в бекенд сервисе.

### Удаленные зависимости

- Прямые вызовы API Альфа-Банка из фронтенда
- Использование `CertificatePaymentData` интерфейса
- Зависимость от `paymentService.createCertificatePayment()`

### Добавленные зависимости

- Новый `certificateService` для работы с собственным API
- Интерфейсы `CreateCertificateRequest` и `Customer`
- Улучшенная обработка ошибок API

## Тестирование

Для тестирования интеграции:

1. Запустите бекенд сервер
2. Убедитесь, что `VITE_API_URL` указывает на правильный адрес
3. Заполните форму на `/certificates`
4. Проверьте создание платежа и редирект
5. Протестируйте успешную и неуспешную оплату

## Troubleshooting

### Ошибки CORS

Убедитесь, что бекенд настроен для работы с фронтенд доменом.

### Ошибки валидации

Проверьте соответствие отправляемых данных структуре `CreateCertificateDto`.

### Проблемы с платежами

Проверьте логи бекенда для детальной информации об ошибках Альфа-Банка.